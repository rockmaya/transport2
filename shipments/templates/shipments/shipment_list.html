{% load static %}
{% load custom_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Shipments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f7f9fc;
            margin: 0;
            padding: 0;
        }

        /* NAVBAR */
        nav {
            position: sticky;
            top: 0;
            z-index: 999;
            background: rgba(255,255,255,0.95);
            padding: 10px 30px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border-bottom: 1px solid #e0e0e0;
            backdrop-filter: blur(5px);
        }

        nav a.btn {
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
        }

        nav a.btn:hover {
            transform: translateY(-2px);
        }

        /* PAGE TITLE */
        h3.page-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 30px;
            position: relative;
        }

        h3.page-title::after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, #4A90E2, #17a2b8);
            margin: 8px auto 0 auto;
            border-radius: 2px;
        }

        /* FILTER FORM */
        .filter-form .form-control-sm, .filter-form .form-select-sm {
            border-radius: 10px;
            font-size: 0.75rem;
            padding: 5px 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            transition: all 0.2s ease-in-out;
        }

        .filter-form .form-control-sm:focus, 
        .filter-form .form-select-sm:focus {
            border-color: #4A90E2;
            box-shadow: 0 0 6px rgba(74,144,226,0.3);
            outline: none;
        }

        .btn-primary {
            background: linear-gradient(90deg, #4A90E2, #17a2b8);
            border: none;
            color: #fff;
        }

        .btn-primary:hover {
            background: linear-gradient(90deg, #357ABD, #138496);
        }

        .btn-success {
            background: #28a745;
            color: #fff;
            border: none;
        }

        .btn-success:hover {
            background: #218838;
        }

/* TABLE CONTAINER */
.table-container {
    max-height: 600px;   /* fix height so vertical scroll works */
    width: auto;
    margin-left: -95px;
    margin-right:-90px;
    overflow-x: auto;
    overflow-y: auto;    /* enable vertical scrolling */
    padding-bottom: 20px;

}

/* MAIN TABLE */
table.table-sm {
    width: 2500px; /* total table width to accommodate all columns */
    border-collapse: collapse;
    border-spacing: 0;
    font-size: 1.5rem; /* increased font size */
    table-layout: fixed; /* ensures fixed column widths */
}

/* TABLE HEADERS */
table.table-sm thead th {
    position: sticky;
    top: 0; /* stick to top */
    z-index: 10;
    background: linear-gradient(135deg, #4A90E2, #17a2b8);
    color: #fff;
    font-weight: 600;
    text-align: center;
    vertical-align: middle;
    padding: 0.5rem 0.5rem;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
    font-size: 0.75rem;
}


/* FIRST TWO HEADER COLUMNS STICKY */
table.table-sm thead th:nth-child(1),
table.table-sm tbody td:nth-child(1) {
    position: sticky;
    left: 0;
    z-index: 22; /* higher than normal cells */
}

table.table-sm thead th:nth-child(2),
table.table-sm tbody td:nth-child(2) {
    position: sticky;
    left: 120px; /* offset after first column */
    z-index: 22;
}

/* TABLE BODY ROWS */
table.table-sm tbody tr {
    background: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    transition: all 0.2s ease-in-out;
}

table.table-sm tbody tr:nth-child(even) {
    background: #f3f6fb;
}

table.table-sm tbody tr:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
}

/* TABLE CELLS */
table.table-sm td {
    text-align: center;
    font-size: 0.75rem;
    vertical-align: middle;
    white-space: normal; /* allow wrapping */
    padding: 0.35rem 0.5rem;
    overflow-wrap: break-word;
    word-wrap: break-word;
    word-break: break-word;
}

/* BODY CELLS OF FIRST TWO COLUMNS */
table.table-sm tbody td:nth-child(1),
table.table-sm tbody td:nth-child(2) {
    background: #fff; /* keep body cell color */
    z-index: 21;      /* ensure above other cells when scrolling */
}

/* FIXED WIDTHS FOR ALL COLUMNS */
table.table-sm th,
table.table-sm td {
    width: 150px; /* adjust as needed */
    word-wrap: break-word; /* wrap text if too long */
}




        /* RESPONSIVE */
        @media (max-width: 1600px) {
            table.table-sm {
                font-size: 0.65rem;
            }
        }
        @media (max-width: 1200px) {
            table.table-sm {
                min-width: 2000px;
            }
        }

        table.table-sm tfoot th {
    background: #e9ecef;
    font-weight: bold;
    text-align: center;
}

/* Column head background for Salary, Insurance, Depreciation */
/* Salary, Insurance, Depreciation header color */
table.table-sm thead th:nth-child(20),
table.table-sm thead th:nth-child(21),
table.table-sm thead th:nth-child(22),
table.table-sm thead th:nth-child(23) {
    background: #a3dc08ff; /* green */
    color: #000;
}

table.table-sm thead th:nth-child(11) {
    background: orange;
    {% comment %} color: #000; {% endcomment %}
}

/* Profit/(Loss) header color - customizable */
:root {
    --profit-col-color: #ed0c53ff; /* default: red */
}

table.table-sm thead th:nth-child(24) {
    background: var(--profit-col-color);
    color: #fff; /* white text for contrast */
}




    </style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top"
     style="width:100%; margin:0; padding:0; top:0; left:0; right:0; backdrop-filter: blur(12px); border-bottom: 1px solid #e0e0e0; z-index:999;">
    <div class="d-flex justify-content-between align-items-center w-100 px-4 py-2">
        <!-- Brand -->
        {% comment %} <a class="navbar-brand fw-bold" href="{% url 'dashboard' %}">GST</a> {% endcomment %}

        <!-- Toggler for mobile -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Navbar Links -->
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav align-items-center">
                {% if user.is_authenticated %}
                    <li class="nav-item me-2">
                        <a href="{% url 'dashboard' %}" class="btn btn-success btn-sm shadow-sm">Dashboard</a>
                    </li>
                    {% if user|in_group:"FixedCostAdmins" %}
                        <li class="nav-item me-2">
                            <a href="{% url 'fixed_cost_config' %}" class="btn btn-warning btn-sm shadow-sm">Manage Fixed Costs</a>
                        </li>
                    {% endif %}
                    {% if user.is_superuser %}
                        <li class="nav-item me-2">
                            <a href="{% url 'manage_vehicle_maintenance' %}" class="btn btn-info btn-sm shadow-sm">Vehicle Maintenance</a>
                        </li>
                    {% endif %}
                    {% comment %} <li class="nav-item me-2">
                        <a href="{% url 'shipment_form' %}" class="btn btn-primary btn-sm shadow-sm">Create Shipment</a>
                    </li> {% endcomment %}
                    {% comment %} <li class="nav-item me-2">
                        <a href="{% url 'shipment_list' %}" class="btn btn-secondary btn-sm shadow-sm">Shipment List</a>
                    </li> {% endcomment %}
                    <li class="nav-item">
                        <a href="{% url 'logout' %}" class="btn btn-danger btn-sm shadow-sm">Logout</a>
                    </li>
                {% else %}
                    <li class="nav-item">
                        <a href="{% url 'login' %}" class="btn btn-primary btn-sm shadow-sm">Login</a>
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>
</nav>



<div class="container mt-5">

    <h3 class="page-title">All Shipments</h3>






    <a href="{% url 'shipment_form' %}" class="btn btn-primary mb-3">Create New Shipment</a>

    <div class="row mb-3 filter-form">
        <div class="col-12">
            <form method="GET" class="row gy-2 gx-3 align-items-center">
                <div class="col-12 col-md-4">
                    <input type="text" name="trip_no" id="trip_no_search" class="form-control form-control-sm"
                           placeholder="Trip No" value="{{ request.GET.trip_no }}">
                </div>
                <div class="col-12 col-md-2 d-flex align-items-center">
                    <label for="from_date" class="me-2 fw-bold">From</label>
                    <input type="date" name="from_date" id="from_date" class="form-control form-control-sm"
                           value="{{ request.GET.from_date }}">
                </div>
                <div class="col-12 col-md-2 d-flex align-items-center">
                    <label for="to_date" class="me-2 fw-bold">To</label>
                    <input type="date" name="to_date" id="to_date" class="form-control form-control-sm"
                           value="{{ request.GET.to_date }}">
                </div>
                <div class="col-12 col-md-3">
                    <input type="text" name="vehicle_no" class="form-control form-control-sm"
                           placeholder="Vehicle No" value="{{ request.GET.vehicle_no }}">
                </div>
                <div class="col-12 col-md-2">
                    <select name="status" class="form-select form-select-sm">
                        <option value="">-- Status --</option>
                        <option value="New" {% if request.GET.status == "New" %}selected{% endif %}>New</option>
                        <option value="Posted" {% if request.GET.status == "Posted" %}selected{% endif %}>Posted</option>
                    </select>
                </div>
                <div class="col-12 col-md-2">
                    <select name="vehicle_owner" class="form-select form-select-sm">
                        <option value="">-- Vehicle Owner --</option>
                        <option value="SFLL" {% if request.GET.vehicle_owner == "SFLL" %}selected{% endif %}>SFLL</option>
                        <option value="GBFML" {% if request.GET.vehicle_owner == "GBFML" %}selected{% endif %}>GBFML</option>
                    </select>
                </div>
                <div class="col-12 col-md-1 d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-sm w-100">Search</button>
                    <a href="{% url 'shipment_export' %}?trip_no={{ request.GET.trip_no }}&from_date={{ request.GET.from_date }}&to_date={{ request.GET.to_date }}&vehicle_no={{ request.GET.vehicle_no }}&status={{ request.GET.status }}"
                       class="btn btn-success btn-sm w-100">Export</a>
                </div>
            </form>
        </div>
    </div>

    <div class="table-container">
        <table class="table table-sm table-bordered table-striped">
            <thead>
                <tr>
                    <th>Trip No</th><th>Date</th>
                            <th>Departure</th>

                    
                    <th>Vehicle No.</th><th>Vehicle Owner</th><th>From</th><th>To</th><th>Item & Qty</th>
                    <th>Up Fuel(LTR) </th>
                    <th>Remaining Fuel(LTR)</th>
                    <th> Fuel Consumption(LTR) </th>
                    <th>Fare</th><th>Recovery Fare</th><th>Actual Fuel Cost</th><th>Toll</th><th>Food</th><th>Repair</th><th>Police</th><th>Without Doc.</th>
                    <th>Maintenance Cost </th>
                    <th>Salary</th><th>Insurance</th><th>Depreciation</th><th>Profit/(Loss)</th>
                            <th>Arrival</th>
        <th>Trip Duration (Days)</th>
                    <th>Status</th><th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for s in shipments %}
                <tr>
                    <td>{{ s.trip_no }}</td>
                    <td>{{ s.date }}</td>
                    <td>{{ s.departure_datetime|date:"M. j, Y, g:i a" }}</td>


                    <td>{{ s.vehicle_no }}</td>
                    <td>{{ s.vehicle_owner }}</td>
                    <td>{{ s.origin }}</td>
                    <td>{{ s.destination }}</td>
                    <td>{{ s.item }}</td>
                    <td>{{ s.fuel_ltr }}</td>
                    
                    <td>{{ s.remaining_fuel }}</td>          <!-- New column -->
                    <td>{{ s.fuel_consumption }}</td>    

                    {% if s.variable_cost %}
                        <td>{{ s.variable_cost.fare|floatformat:2 }}</td>
                        <td>{{ s.variable_cost.recovery_fare|floatformat:2 }}</td>
                        <td>{{ s.variable_cost.fuel_tk|floatformat:2 }}</td>
                        <td>{{ s.variable_cost.toll|floatformat:2 }}</td>
                        <td>{{ s.variable_cost.food|floatformat:2 }}</td>
                        <td>{{ s.variable_cost.repair|floatformat:2 }}</td>
                        <td>{{ s.variable_cost.police|floatformat:2 }}</td>
                        <td>{{ s.variable_cost.without_doc|floatformat:2 }}</td>
                        <td>{{ s.maintenance_cost|floatformat:2 }}</td>

                    {% else %}
                        <td colspan="8" class="text-center">0.00</td>
                    {% endif %}

                    <td>{{ s.prorated_salary|floatformat:2 }}</td>
                    <td>{{ s.prorated_insurance|floatformat:2 }}</td>
                    <td>{{ s.prorated_depriciation|floatformat:2 }}</td>
                    <td>{{ s.total_cost }}</td>
                    <td>{{ s.arrival_datetime|date:"M. j, Y, g:i a" }}</td>

<td>{{ s.trip_duration_days }}</td>
                    <td>{{ s.status }}</td>
<td>
    {% if s.status == "New" %}
        <a href="{% url 'shipment_edit' s.id %}" class="btn btn-sm btn-warning">Edit</a>
        <a href="{% url 'shipment_delete' s.id %}" class="btn btn-sm btn-danger"
           onclick="return confirm('Are you sure you want to delete this shipment?');">Delete</a>
    {% elif s.status == "Posted" and user.is_superuser %}
        <a href="{% url 'shipment_undo' s.id %}" class="btn btn-sm btn-info"
           onclick="return confirm('Are you sure you want to undo this shipment? It will become editable.');">Undo</a>
    {% else %}
        <span class="text-muted">Posted</span>
    {% endif %}
</td>


                </tr>
                {% empty %}
                <tr>
                    <td colspan="22" class="text-center">No Shipments Found</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
    <tr>
        <th colspan="7" class="text-end">Total:</th>
        <th id = "totalUpFuel">0.00</th>
        <th id = "totalremainingFuel">0.00</th>
        <th id = "totalcosumedFuel">0.00</th>
        <th id="totalFare">0.00</th>
        <th id="totalRecoveryFare">0.00</th>
        <th id="totalFuelTk">0.00</th>
        <th id="totalToll">0.00</th>
        <th id="totalFood">0.00</th>
        <th id="totalRepair">0.00</th>
        <th id="totalPolice">0.00</th>
        <th id="totalWithoutDoc">0.00</th>
        <th id="totalMaintenanceCost">0.00</th>
        <th id="totalSalary">0.00</th>
        <th id="totalInsurance">0.00</th>
        <th id="totalDepreciation">0.00</th>
        <th id="totalProfit">0.00</th>
        <th colspan="2"></th>
    </tr>
</tfoot>

        </table>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
$(function() {
    $("#trip_no_search").autocomplete({
        source: "{% url 'shipment_trip_suggestions' %}",
        minLength: 1,
        select: function(event, ui) {
            $(this).val(ui.item.value);
            $(this).closest('form').submit();
        }
    });

    $("input[name='vehicle_no']").autocomplete({
        source: "{% url 'shipment_vehicle_suggestions' %}",
        minLength: 1,
        select: function(event, ui) {
            $(this).val(ui.item.value);
            $(this).closest('form').submit();
        }
    });

    if (performance.getEntriesByType("navigation")[0].type === "reload") {
        window.location.replace("{% url 'shipment_list' %}");
    }
});

$(document).ready(function() {
    function sumColumn(index) {
        let total = 0;
        $("table.table-sm tbody tr").each(function() {
            const val = parseFloat($(this).find("td").eq(index).text().replace(/,/g, "")) || 0;
            total += val;
        });
        return total.toFixed(2);
    }

    $("#totalUpFuel").text(sumColumn(7));        // Up Fuel
    $("#totalremainingFuel").text(sumColumn(8)); // Remaining Fuel
    $("#totalcosumedFuel").text(sumColumn(9));   // Fuel Consumption
    $("#totalFare").text(sumColumn(10));
    $("#totalRecoveryFare").text(sumColumn(11));
    $("#totalFuelTk").text(sumColumn(12));
    $("#totalToll").text(sumColumn(13));
    $("#totalFood").text(sumColumn(14));
    $("#totalRepair").text(sumColumn(15));
    $("#totalPolice").text(sumColumn(16));
    $("#totalWithoutDoc").text(sumColumn(17));
    $("#totalMaintenanceCost").text(sumColumn(18));
    $("#totalSalary").text(sumColumn(19));
    $("#totalInsurance").text(sumColumn(20));
    $("#totalDepreciation").text(sumColumn(21));
    $("#totalProfit").text(sumColumn(22));
});

</script>

</body>
</html>
