
{% load static %}
{% load custom_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Shipments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        table.table-sm th, table.table-sm td {
            font-size: 0.8rem;
            padding: 0.3rem;
        }
    </style>
</head>

{% load custom_tags %}

<nav class="d-flex justify-content-end align-items-center mb-2" style="margin-right: 30px; margin-top: 10px;">
    {% if user.is_authenticated %}
        {% if user|in_group:"FixedCostAdmins" %}
            <a href="{% url 'fixed_cost_config' %}" class="btn btn-warning btn-sm me-2">Manage Fixed Costs</a>
        {% endif %}
        {% comment %} <span class="me-2">{{ user.username }}!</span> {% endcomment %}
        <a href="{% url 'logout' %}" class="btn btn-outline-danger btn-sm">Logout</a>
    {% else %}
        <a href="{% url 'login' %}" class="btn btn-outline-primary btn-sm">Login</a>
    {% endif %}
</nav>







<body>
<div class="container mt-5">
    <h3 class="mb-4 text-center"><b><u>All Shipments</u></b></h3>

    <a href="{% url 'shipment_form' %}" class="btn btn-primary mb-3">New Shipment</a>
    

<div class="row mb-3">
    <div class="col-sm-12">
        <form method="GET" class="row gy-2 gx-3 align-items-center">

            <!-- Line 1: Trip No -->
            <div class="col-12 col-md-4">
                <input type="text" name="trip_no" id="trip_no_search" 
                       class="form-control form-control-sm"
                       placeholder="Trip No" 
                       value="{{ request.GET.trip_no }}">
            </div>

            <!-- Line 2: From & To Date -->
            <div class="col-12 col-md-2 d-flex align-items-center">
                <label for="from_date" class="me-2 fw-bold">From</label>
                <input type="date" name="from_date" id="from_date"
                       class="form-control form-control-sm"
                       value="{{ request.GET.from_date }}">
            </div>
            <div class="col-12 col-md-2 d-flex align-items-center">
                <label for="to_date" class="me-2 fw-bold">To</label>
                <input type="date" name="to_date" id="to_date"
                       class="form-control form-control-sm"
                       value="{{ request.GET.to_date }}">
            </div>

            <!-- Line 3: Vehicle No + Status -->
            <div class="col-12 col-md-3">
                <input type="text" name="vehicle_no" class="form-control form-control-sm"
                       placeholder="Vehicle No" value="{{ request.GET.vehicle_no }}">
            </div>
<div class="col-12 col-md-2">
<select name="status" class="form-select form-select-sm">
    <option value="">-- Status --</option>
    <option value="New" {% if request.GET.status == "New" %}selected{% endif %}>New</option>
    <option value="Posted" {% if request.GET.status == "Posted" %}selected{% endif %}>Posted</option>
</select>

</div>

<div class="col-12 col-md-2">
    <select name="vehicle_owner" class="form-select form-select-sm">
        <option value="">-- Vehicle Owner --</option>
        <option value="SFLL" {% if request.GET.vehicle_owner == "SFLL" %}selected{% endif %}>SFLL</option>
        <option value="GBFML" {% if request.GET.vehicle_owner == "GBFML" %}selected{% endif %}>GBFML</option>
    </select>
</div>



            <!-- Buttons -->
            <div class="col-12 col-md-1 d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm w-100">Search</button>
                <a href="{% url 'shipment_export' %}?trip_no={{ request.GET.trip_no }}&from_date={{ request.GET.from_date }}&to_date={{ request.GET.to_date }}&vehicle_no={{ request.GET.vehicle_no }}&status={{ request.GET.status }}"
                   class="btn btn-success btn-sm w-100">Export</a>
            </div>
        </form>
    </div>
</div>


    <table class="table table-bordered table-striped table-sm">
        <thead>
            <tr>
                <th>Trip No</th>
                <th>Date</th>
                <th>Vehicle</th>
                <th>Owner</th>
                <th>From</th>
                <th>To</th>
                <th>Item & Qty</th>
                <th>Fuel (Ltr)</th>
                <th>Fare</th>
                <th>Recovery Fare</th>
                <th>Fuel (TK)</th>
                <th>Toll</th>
                <th>Food</th>
                <th>Repair</th>
                <th>Police</th>
                <th>Without Doc.</th>
                <th>Salary</th>
                <th>Insurance</th>
                <th>Depriciation</th>
                <th>Profit/(Loss)</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
    <tbody>
{% for s in shipments %}
    <tr>
        <td>{{ s.trip_no }}</td>
        <td>{{ s.date }}</td>
        <td>{{ s.vehicle_no }}</td>
        <td>{{ s.vehicle_owner }}</td>
        <td>{{ s.origin }}</td>
        <td>{{ s.destination }}</td>
        <td>{{ s.item }}</td>
        <td>{{ s.fuel_ltr }}</td>

        {% if s.variable_cost %}
            <td>{{ s.variable_cost.fare|floatformat:2 }}</td>
            <td>{{ s.variable_cost.recovery_fare|floatformat:2 }}</td>
            <td>{{ s.variable_cost.fuel_tk|floatformat:2 }}</td>
            <td>{{ s.variable_cost.toll|floatformat:2 }}</td>
            <td>{{ s.variable_cost.food|floatformat:2 }}</td>
            <td>{{ s.variable_cost.repair|floatformat:2 }}</td>
            <td>{{ s.variable_cost.police|floatformat:2 }}</td>
            <td>{{ s.variable_cost.without_doc|floatformat:2 }}</td>
        {% else %}
            <td colspan="8" class="text-center">0.00</td>
        {% endif %}


        <td>{{ s.prorated_salary|floatformat:2 }}</td>
        <td>{{ s.prorated_insurance|floatformat:2 }}</td>
        <td>{{ s.prorated_depriciation|floatformat:2 }}</td>

        <td>{{ s.total_cost }}</td>

        <td>{{ s.status }}</td>
<td>
    {% if s.status == "New" %}
        <a href="{% url 'shipment_edit' s.id %}" class="btn btn-sm btn-warning">Edit</a>
        <a href="{% url 'shipment_delete' s.id %}" class="btn btn-sm btn-danger"
           onclick="return confirm('Are you sure you want to delete this shipment?');">Delete</a>
    {% else %}
        <span class="text-muted">Posted</span>
    {% endif %}
</td>

    </tr>
{% empty %}
    <tr>
        <td colspan="21" class="text-center">No Shipments Found</td>
    </tr>
{% endfor %}




</tbody>

    </table>

</div>





<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<script>
$(function() {
    // Trip No Autocomplete
    $("#trip_no_search").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "{% url 'shipment_trip_suggestions' %}",
                dataType: "json",
                data: { term: request.term },
                success: function(data) {
                    response(data);
                }
            });
        },
        minLength: 1,
        select: function(event, ui) {
            $(this).val(ui.item.value);
            $(this).closest('form').submit();
        }
    });

    // Vehicle No Autocomplete
    $("input[name='vehicle_no']").autocomplete({
        source: function(request, response) {
            $.ajax({
                url: "{% url 'shipment_vehicle_suggestions' %}",
                dataType: "json",
                data: { term: request.term },
                success: function(data) {
                    response(data);
                }
            });
        },
        minLength: 1,
        select: function(event, ui) {
            $(this).val(ui.item.value);
            $(this).closest('form').submit();
        }
    });

    // Redirect to base URL on page refresh if any GET params exist
    // Only redirect on a true page refresh
    if (performance.getEntriesByType("navigation")[0].type === "reload") {
        window.location.replace("{% url 'shipment_list' %}");
    }
});
</script>




</body>
</html>
